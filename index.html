<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<script>
  let tokenClient;
  let gapiInited = false;
  let gisInited = false;

  const CLIENT_ID = '246049552174-fqcrsh2uvcpouptn1tij8t7bh686h4ad.apps.googleusercontent.com';
  const API_KEY = ''; // Si lo necesitas para otros servicios
  const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

  // Load gapi.client
  function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
  }

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  // Load GIS
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (tokenResponse) => {
        console.log('Usuari Autenticat');
        llistarCorreus();
      },
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      // AquÃ­ puedes auto-iniciar si quieres
      tokenClient.requestAccessToken();
    }
  }

  async function llistarCorreus() {
    const response = await gapi.client.gmail.users.messages.list({
      userId: 'me',
      maxResults: 5,
    });
    const messages = response.result.messages;
    if (!messages || messages.length === 0) {
      console.log('No se encontraron mensajes.');
    } else {
      console.log('Mensajes:', messages);
    }
  }

  window.onload = () => {
    gapiLoaded();
    gisLoaded();
  };
</script>
